# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# FIREWALL (UFW)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
manage_ufw() {
    while true; do
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ ufw
        local ufw_installed=0
        command -v ufw >/dev/null 2>&1 && ufw_installed=1

        if [ "$ufw_installed" -eq 0 ]; then
            show_arrow_menu "FIREWALL (UFW)" \
                "üõ°Ô∏è   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Firewall (ufw)" \
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" \
                "üìã  –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã" \
                "‚ûï  –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç" \
                "‚ûñ  –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ" \
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" \
                "‚ùå  –ù–∞–∑–∞–¥"
            local choice=$?

            # –ò–Ω–¥–µ–∫—Å 0 ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ufw
            if [ "$choice" -eq 0 ]; then
                (apt-get install -y ufw >/dev/null 2>&1) &
                show_spinner "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ UFW"
                if command -v ufw >/dev/null 2>&1; then
                    print_success "UFW —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
                else
                    print_error "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å UFW"
                fi
                echo
                read -s -n 1 -p "$(echo -e "${DARKGRAY}   Enter: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å${NC}")"
                echo
                continue
            fi
            # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (index 1) ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            [ "$choice" -eq 1 ] && continue
            # –ù–∞–∑–∞–¥ (index 6 –≤ –Ω–µ-—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º –º–µ–Ω—é) ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è
            [ "$choice" -eq 6 ] && return
            # –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–¥–≤–∏–Ω—É—Ç—ã –Ω–∞ 2 (—É–±–∏—Ä–∞–µ–º "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å)
            choice=$((choice - 2))
        else
            # –°—Ç–∞—Ç—É—Å UFW
            clear
            echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
            echo -e "${GREEN}        üî• FIREWALL (UFW)${NC}"
            echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
            echo

            local ufw_status
            ufw_status=$(ufw status 2>/dev/null | head -1)
            if echo "$ufw_status" | grep -q "active"; then
                print_success "UFW –∞–∫—Ç–∏–≤–µ–Ω"
            else
                print_warning "UFW –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
            fi
            echo

            show_arrow_menu "FIREWALL (UFW)" \
                "üìã  –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã" \
                "‚ûï  –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç" \
                "‚ûñ  –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ" \
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" \
                "üóëÔ∏è   –£–¥–∞–ª–∏—Ç—å Firewall (ufw)" \
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" \
                "‚ùå  –ù–∞–∑–∞–¥"
            local choice=$?
        fi

        case $choice in
            0)
                # –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã
                clear
                echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
                echo -e "${GREEN}     üìã –û–¢–ö–†–´–¢–´–ï –ü–û–†–¢–´ (UFW)${NC}"
                echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
                echo
                ufw status numbered 2>/dev/null | tail -n +4
                echo
                echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
                read -s -n 1 -p "$(echo -e "${DARKGRAY}   Enter: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å${NC}")"
                echo
                ;;
            1)
                # –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç
                clear
                echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
                echo -e "${GREEN}        ‚ûï –û–¢–ö–†–´–¢–¨ –ü–û–†–¢${NC}"
                echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
                echo

                local ufw_port ufw_proto ufw_comment ufw_ip

                reading_inline "–ü–æ—Ä—Ç (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):" ufw_port
                if [ -z "$ufw_port" ] || ! [[ "$ufw_port" =~ ^[0-9]+$ ]]; then
                    print_error "–ü–æ—Ä—Ç –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
                    echo
                    read -s -n 1 -p "$(echo -e "${DARKGRAY}   Enter: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å${NC}")"
                    echo
                    continue
                fi

                reading_inline "–ü—Ä–æ—Ç–æ–∫–æ–ª (tcp/–ø—É—Å—Ç–æ –¥–ª—è any):" ufw_proto
                reading_inline "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (Enter –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞):" ufw_comment
                reading_inline "IP-–∞–¥—Ä–µ—Å (Enter –¥–ª—è –≤—Å–µ—Ö):" ufw_ip

                echo

                # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª–æ —á–µ—Ä–µ–∑ –º–∞—Å—Å–∏–≤ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (–±–µ–∑ eval, –±–µ–∑ –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–æ–±–µ–ª–∞–º–∏)
                local cmd_args=("ufw" "allow")
                if [ -n "$ufw_ip" ]; then
                    cmd_args+=("from" "$ufw_ip")
                fi
                cmd_args+=("to" "any" "port" "$ufw_port")
                if [ -n "$ufw_proto" ]; then
                    cmd_args+=("proto" "$ufw_proto")
                fi
                if [ -n "$ufw_comment" ]; then
                    cmd_args+=("comment" "$ufw_comment")
                fi

                (
                    "${cmd_args[@]}" >/dev/null 2>&1
                ) &
                show_spinner "–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–∞ $ufw_port"

                print_success "–ü–æ—Ä—Ç $ufw_port –æ—Ç–∫—Ä—ã—Ç"
                [ -n "$ufw_proto" ] && echo -e "  ${DARKGRAY}–ü—Ä–æ—Ç–æ–∫–æ–ª: ${WHITE}${ufw_proto}${NC}"
                [ -n "$ufw_ip" ] && echo -e "  ${DARKGRAY}–î–ª—è IP: ${WHITE}${ufw_ip}${NC}"
                [ -n "$ufw_comment" ] && echo -e "  ${DARKGRAY}–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${WHITE}${ufw_comment}${NC}"
                echo
                echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
                read -s -n 1 -p "$(echo -e "${DARKGRAY}   Enter: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å${NC}")"
                echo
                ;;
            2)
                # –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ ‚Äî –æ—Å—Ç–∞—ë–º—Å—è –≤ —ç—Ç–æ–º –º–µ–Ω—é –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–º–µ–Ω—ã
                while true; do
                    # –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª –Ω–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                    local rules=()
                    while IFS= read -r line; do
                        local rule_text
                        rule_text=$(echo "$line" | sed 's/^\[\s*[0-9]*\]\s*//')
                        [ -n "$rule_text" ] && rules+=("$rule_text")
                    done < <(ufw status numbered 2>/dev/null | grep '^\[')

                    if [ ${#rules[@]} -eq 0 ]; then
                        clear
                        echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
                        echo -e "${GREEN}       ‚ûñ –£–î–ê–õ–ò–¢–¨ –ü–†–ê–í–ò–õ–û${NC}"
                        echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
                        echo
                        print_warning "–ù–µ—Ç –ø—Ä–∞–≤–∏–ª –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"
                        echo
                        read -s -n 1 -p "$(echo -e "${DARKGRAY}   Enter: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å${NC}")"
                        echo
                        break
                    fi

                    # –§–æ—Ä–º–∏—Ä—É–µ–º –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–æ–π "–ù–∞–∑–∞–¥"
                    local menu_items=()
                    for r in "${rules[@]}"; do
                        menu_items+=("$r")
                    done
                    menu_items+=("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
                    menu_items+=("‚ùå  –ù–∞–∑–∞–¥")

                    show_arrow_menu "–£–î–ê–õ–ò–¢–¨ –ü–†–ê–í–ò–õ–û" "${menu_items[@]}"
                    local del_choice=$?

                    local total_rules=${#rules[@]}
                    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –∏–ª–∏ "–ù–∞–∑–∞–¥" ‚Äî –≤—ã—Ö–æ–¥–∏–º –∏–∑ –ø–æ–¥–º–µ–Ω—é
                    if [ "$del_choice" -ge "$total_rules" ]; then
                        break
                    fi

                    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Äî –Ω–µ –ø–æ–∫–∏–¥–∞–µ–º –ø–æ–¥–º–µ–Ω—é –Ω–∏ –ø—Ä–∏ –∫–∞–∫–æ–º –æ—Ç–≤–µ—Ç–µ
                    echo
                    echo -e "${YELLOW}–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ: ${WHITE}${rules[$del_choice]}${NC}"
                    echo
                    if ! confirm_action; then
                        # Esc ‚Äî –æ—Ç–º–µ–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –ø—Ä–∞–≤–∏–ª –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è
                        continue
                    fi

                    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ ‚Äî —É–¥–∞–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–æ
                    local rule_num=$((del_choice + 1))
                    echo
                    (
                        echo "y" | ufw delete "$rule_num" >/dev/null 2>&1
                    ) &
                    show_spinner "–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞"
                    print_success "–ü—Ä–∞–≤–∏–ª–æ —É–¥–∞–ª–µ–Ω–æ: ${rules[$del_choice]}"
                    sleep 1
                    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª ‚Äî —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                done
                ;;
            3) continue ;;
            4)
                # –£–¥–∞–ª–∏—Ç—å UFW
                echo
                echo -e "${YELLOW}–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å UFW?${NC}"
                if ! confirm_action; then
                    print_error "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"
                    sleep 2
                    continue
                fi
                echo
                (
                    ufw disable >/dev/null 2>&1 || true
                    apt-get remove -y ufw >/dev/null 2>&1
                ) &
                show_spinner "–£–¥–∞–ª–µ–Ω–∏–µ UFW"
                if ! command -v ufw >/dev/null 2>&1; then
                    print_success "UFW —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω"
                else
                    print_error "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å UFW"
                fi
                echo
                read -s -n 1 -p "$(echo -e "${DARKGRAY}   Enter: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å${NC}")"
                echo
                ;;
            5) continue ;;
            6) return ;;
        esac
    done
}
